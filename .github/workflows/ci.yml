name: FRAITMO CI/CD Pipeline

on:
  pull_request:
    branches: [ main ]
  push:
    branches: [ main ]

jobs:
  code-quality:
    name: Code Quality Checks
    runs-on: ubuntu-latest
    
    steps:
    - name: Checkout code
      uses: actions/checkout@v4
      
    - name: Set up Python 3.9
      uses: actions/setup-python@v4
      with:
        python-version: '3.9'
        
    - name: Cache pip dependencies
      uses: actions/cache@v3
      with:
        path: ~/.cache/pip
        key: ${{ runner.os }}-pip-${{ hashFiles('**/requirements.txt') }}
        restore-keys: |
          ${{ runner.os }}-pip-
          
    - name: Install dependencies
      run: |
        python -m pip install --upgrade pip
        pip install -r requirements.txt
        
    - name: Python syntax check
      run: |
        echo "ðŸ” Checking Python syntax..."
        python -m py_compile fraitmo.py
        python -m py_compile export_results.py
        find pipeline/ -name "*.py" -exec python -m py_compile {} \;
        find rag/ -name "*.py" -exec python -m py_compile {} \;
        find models/ -name "*.py" -exec python -m py_compile {} \;
        find dfd_parser/ -name "*.py" -exec python -m py_compile {} \;
        echo "âœ… All Python files compile successfully"
        
    - name: Import validation
      run: |
        echo "ðŸ” Testing critical imports..."
        python -c "
        try:
            from pipeline.graph import create_fraitmo_graph, run_fraitmo_analysis
            from pipeline.state import ThreatAnalysisState
            from rag.llm_client import UnifiedLLMClient
            from models.schema import DataFlowDiagram
            from dfd_parser.xml_parser import extract_from_xml
            from export_results import export_threats_to_json, export_threats_to_csv
            print('âœ… All critical imports successful')
        except ImportError as e:
            print(f'âŒ Import failed: {e}')
            exit(1)
        "
        
    - name: Code structure validation
      run: |
        echo "ðŸ” Validating project structure..."
        test -f fraitmo.py || (echo "âŒ Missing fraitmo.py" && exit 1)
        test -f requirements.txt || (echo "âŒ Missing requirements.txt" && exit 1)
        test -d pipeline/ || (echo "âŒ Missing pipeline directory" && exit 1)
        test -d rag/ || (echo "âŒ Missing rag directory" && exit 1)
        test -d models/ || (echo "âŒ Missing models directory" && exit 1)
        test -d dfd_parser/ || (echo "âŒ Missing dfd_parser directory" && exit 1)
        echo "âœ… Project structure is valid"
        
    - name: Basic functionality test
      run: |
        echo "ðŸ” Testing basic functionality..."
        python -c "
        import argparse
        import sys
        
        # Test argument parsing
        parser = argparse.ArgumentParser()
        parser.add_argument('dfd_file')
        parser.add_argument('--mitigation', action='store_true')
        parser.add_argument('--output', choices=['json', 'csv'])
        
        # Test with mock args
        test_args = parser.parse_args(['test.xml', '--output', 'json'])
        assert test_args.dfd_file == 'test.xml'
        assert test_args.output == 'json'
        print('âœ… Argument parsing works correctly')
        
        # Test LLM client initialization
        from rag.llm_client import UnifiedLLMClient
        client = UnifiedLLMClient()
        print('âœ… LLM client can be initialized')
        
        # Test state schema
        from pipeline.state import ThreatAnalysisState
        print('âœ… State schema is valid')
        
        print('âœ… Basic functionality test passed')
        "

  security-scan:
    name: Security Scan
    runs-on: ubuntu-latest
    
    steps:
    - name: Checkout code
      uses: actions/checkout@v4
      
    - name: Set up Python 3.9
      uses: actions/setup-python@v4
      with:
        python-version: '3.9'
        
    - name: Install security tools
      run: |
        pip install bandit safety
        
    - name: Run Bandit security scan
      run: |
        echo "ðŸ” Running security scan with Bandit..."
        bandit -r . -f json -o bandit-report.json || true
        bandit -r . --severity-level medium --confidence-level medium
        echo "âœ… Security scan completed"
        
    - name: Check for known vulnerabilities
      run: |
        echo "ðŸ” Checking for known vulnerabilities..."
        safety check || echo "âš ï¸ Some dependencies may have known vulnerabilities"
        
    - name: Check for secrets
      run: |
        echo "ðŸ” Scanning for potential secrets..."
        grep -r -i "password\|secret\|key\|token" --exclude-dir=.git --exclude="*.yml" . || echo "âœ… No obvious secrets found"

  documentation:
    name: Documentation Check
    runs-on: ubuntu-latest
    
    steps:
    - name: Checkout code
      uses: actions/checkout@v4
      
    - name: Check README exists and is substantial
      run: |
        echo "ðŸ” Checking documentation..."
        test -f README.md || (echo "âŒ README.md missing" && exit 1)
        
        # Check README has substantial content (>500 chars)
        readme_size=$(wc -c < README.md)
        if [ "$readme_size" -lt 500 ]; then
          echo "âš ï¸ README.md seems too short (${readme_size} chars)"
        else
          echo "âœ… README.md has substantial content (${readme_size} chars)"
        fi
        
    - name: Check for essential documentation sections
      run: |
        echo "ðŸ” Checking for essential documentation sections..."
        grep -i "installation\|setup\|usage\|example" README.md && echo "âœ… README has essential sections" || echo "âš ï¸ Consider adding installation/usage sections" 